import{M as o,N as e,R as pe}from"./vendor-react-Dc2o_H4k.js";import{R as me}from"./vendor-Ct8sJpkz.js";import{p as fe,q as ge,h as he,D as N,t as u,L as J,r as xe,P as ve,a as be}from"./game-core-C_gBomU2.js";import{u as ye,S as Ne,G as Se,a as je,C as _e,b as we,L as Ee,R as z,c as V,B as W,P as Ae}from"./ui-shared-C4Cta63V.js";import"./lang-pl-C2fTcB1W.js";import"./lang-cz-CLz4Wpzs.js";import"./lang-en-BtrdBcOK.js";import"./lang-ponaszymu-DrdZSv2I.js";import"./vendor-visuals-BQkZI2F5.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))d(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const p of n.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&d(p)}).observe(document,{childList:!0,subtree:!0});function f(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function d(a){if(a.ep)return;a.ep=!0;const n=f(a);fetch(a.href,n)}})();const M="mafia_manager_state";function Le(){const[l,r]=o.useState(()=>{try{const a=localStorage.getItem(M);return a?JSON.parse(a):null}catch(a){return console.error("Failed to load save",a),null}}),f=o.useCallback(a=>{try{localStorage.setItem(M,JSON.stringify(a)),r(a)}catch(n){console.error("Failed to save game",n)}},[]),d=o.useCallback(()=>{localStorage.removeItem(M),r(null)},[]);return{savedState:l,saveGame:f,clearSave:d}}const Me=l=>{if(!l||typeof l!="object")return!1;const r=l;return Array.isArray(r.past)&&Array.isArray(r.future)&&typeof r.present=="object"&&r.present!==null};function Ce(){const{savedState:l,saveGame:r,clearSave:f}=Le(),[d,a]=o.useReducer(fe,ge),[n,p]=o.useState(()=>typeof window>"u"?"LANG_SELECT":new URLSearchParams(window.location.search).get("data")?"PLAYER_GAME":"LANG_SELECT"),[i,v]=o.useState("GAME"),[w,K]=o.useState(null),[S,q]=o.useState("pl"),[b,X]=o.useState(null),[Q,Z]=o.useState(null),[C,ee]=o.useState("icon"),s=d.present,c=s.settings.language,j=ye(),[h,I]=o.useState(()=>j?.lang??"pl"),T=o.useRef(null),ae=o.useCallback(t=>{if(!l)return;const m=Ie(l,t);r(m)},[l,r]);o.useEffect(()=>{const t=()=>{if(typeof window>"u")return;const m=window.innerHeight*.01;document.documentElement.style.setProperty("--app-vh",`${m}px`)};return t(),window.addEventListener("resize",t),window.addEventListener("orientationchange",t),()=>{window.removeEventListener("resize",t),window.removeEventListener("orientationchange",t)}},[]),o.useEffect(()=>{j?.lang&&I(j.lang)},[j?.lang]),o.useEffect(()=>{if(typeof document>"u")return;const t=n==="PLAYER_GAME"?h:c;document.documentElement.lang=he(t)},[c,n,h]);const y={minHeight:"calc(var(--app-vh, 1vh) * 100)"},R={height:"calc(4rem + var(--safe-area-bottom, env(safe-area-inset-bottom, 0px)))"},te=!!s.uiState.pendingDayReport?.length,E=s.phase==="DAY_ANNOUNCEMENT"||te,_=Math.max(1,s.currentRound||1),se=Math.min(Q??_,_),P=o.useMemo(()=>Te(s),[s]),G=o.useMemo(()=>s.activeCard?s.players.find(m=>m.cards.some(g=>g.cardId===s.activeCard.cardId&&g.instance===s.activeCard.instance))?.id??null:null,[s.players,s.activeCard]),A=o.useMemo(()=>{if(s.phase!=="NIGHT_ACTIVE"||s.activeCard?.cardId!=="Spyglass")return null;const m=(s.nightCache.spyglassRevealIds??[]).filter(g=>g!==G);return new Set(m)},[s.phase,s.activeCard,s.nightCache.spyglassRevealIds,G]),L=o.useMemo(()=>{if(s.phase!=="DAY_MAIN")return null;const t=s.uiState.dayAction;if(t?.kind!=="MASS_MURDERER_RETALIATION")return null;const m=t.massMurderer?.selectedIds??[];return new Set(m)},[s.phase,s.uiState.dayAction]),ne=o.useMemo(()=>{if(!A&&!L)return;const t=new Set;return A?.forEach(m=>t.add(m)),L?.forEach(m=>t.add(m)),t},[A,L]),k=Math.round(be/N*100),D=Math.round(ve/N*100),le=Math.round(s.settings.playerNodeScale/N*100),O=Math.min(D,Math.max(k,le)),U=150,H=1500,Y=Math.min(H,Math.max(U,s.settings.bulletSpeed)),B="rounded-2xl border border-[rgba(242,200,121,0.3)] bg-[rgba(255,255,255,0.02)] p-4 text-left transition shadow-[0_10px_25px_rgba(0,0,0,0.45)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-[var(--color-brass)] disabled:cursor-default backdrop-blur",re=t=>{const m=_,g=Math.min(Math.max(1,t),m);Z(g===_?null:g)},ie=t=>{P.has(t)||(K(t),a({type:"GM_CLICK_PLAYER",payload:t}))},oe=t=>{t!==c&&a({type:"UPDATE_SETTINGS",payload:{language:t}})},de=t=>{t!==h&&I(t)},F=t=>{ee(t)},ce=o.useCallback(()=>{if(!(typeof document>"u"))try{const t=new Blob([JSON.stringify(d,null,2)],{type:"application/json"}),m=new Date().toISOString().replace(/[:.]/g,"-"),g=URL.createObjectURL(t),x=document.createElement("a");x.href=g,x.download=`mafia-game-${m}.json`,document.body.appendChild(x),x.click(),document.body.removeChild(x),setTimeout(()=>URL.revokeObjectURL(g),0)}catch(t){console.error("Failed to export game data",t)}},[d]),ue=o.useCallback(async t=>{const m=t.target.files?.[0];if(m)try{const g=await m.text(),x=JSON.parse(g);if(!Me(x))throw new Error("Invalid save format");a({type:"LOAD_GAME",payload:x}),r(x),p("GM_GAME")}catch(g){console.error("Failed to import game data",g),typeof window<"u"&&window.alert(u("settings_import_error",c))}finally{t.target.value=""}},[a,r,c,p]);if(o.useEffect(()=>{n==="GM_GAME"&&s.phase!=="SETUP"&&r(d)},[d,n,r,s.phase]),n==="LANG_SELECT")return e.jsx("div",{className:"mafia-app flex items-center justify-center px-6",style:y,children:e.jsxs("div",{className:"mafia-screen flex flex-col items-center gap-8 rounded-[2.5rem] p-8 text-center w-full max-w-2xl",children:[e.jsx("span",{className:"mafia-badge",children:"Town of Palermo"}),e.jsx("h1",{className:"mafia-title text-4xl",children:u("app_title",S)}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 w-full",children:J.map(t=>e.jsx("button",{onClick:()=>{q(t.code),a({type:"UPDATE_SETTINGS",payload:{language:t.code}}),ae(t.code),p("GM_SETUP")},className:"mafia-button mafia-button--ember py-4 px-8 rounded-2xl font-bold tracking-[0.3em] uppercase",children:t.label},t.code))})]})});if(n==="GM_SETUP"){const t=l?.present.settings.language??S;return e.jsx("div",{className:"mafia-app flex items-center justify-center px-6",style:y,children:e.jsxs("div",{className:"mafia-screen flex flex-col items-center gap-6 rounded-[2.5rem] p-8 text-center w-full max-w-xl",children:[l&&e.jsxs("button",{onClick:()=>{a({type:"LOAD_GAME",payload:l}),p("GM_GAME")},className:"w-full mafia-button mafia-button--brass py-4 rounded-2xl font-bold text-base tracking-[0.3em] uppercase",children:[u("app_continue_game",t),e.jsx("br",{}),e.jsx("span",{className:"text-xs font-normal tracking-[0.2em]",children:u("app_continue_round",t,{round:l.present.currentRound})})]}),e.jsx("button",{onClick:()=>{f(),p("GM_GAME")},className:"w-full border border-[rgba(242,200,121,0.35)] text-white py-4 rounded-2xl font-bold text-base tracking-[0.3em] uppercase hover:bg-white/5 transition",children:u("app_new_game",S)})]})})}return n==="GM_GAME"?s.phase==="SETUP"?e.jsx("div",{className:"mafia-app p-4",style:y,children:e.jsx("div",{className:"mafia-screen rounded-[2rem] p-4 md:p-8 w-full h-full overflow-hidden",children:e.jsx(Ne,{dispatch:a,language:S})})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mafia-app flex flex-col overflow-hidden",style:y,children:[e.jsxs("div",{className:"flex-1 relative overflow-hidden mafia-screen flex flex-col min-h-0 rounded-t-[2rem] border border-[rgba(242,200,121,0.12)] p-3 sm:p-6",children:[i==="GAME"&&e.jsxs("div",{className:"h-full flex flex-1 flex-col min-h-0 gap-4",children:[!E&&e.jsx("div",{className:"flex-1 min-h-0 overflow-hidden",children:e.jsxs("div",{className:"h-full min-h-0 flex flex-col gap-4 lg:flex-row lg:items-start",children:[e.jsx("div",{className:"mafia-panel flex-1 min-h-0 p-4 lg:flex-1 lg:basis-1/2",style:b?{height:b,maxHeight:b}:void 0,children:e.jsx(Se,{players:s.players,phase:s.phase,selectedId:w,onSelect:ie,tunnels:s.globalTunnels,disabledPlayerIds:P,playerNodeScale:s.settings.playerNodeScale,onTableSizeChange:X,highlightedPlayerIds:ne,communistSuppressionActive:s.uiState.communistSuppressionActive,bulletAnimations:s.nightCache.bulletAnimations,bulletSpeed:s.settings.bulletSpeed,bulletReplayNonce:s.uiState.bulletReplayNonce,matrixTrapPlayerId:s.nightCache.matrixTrap?.playerId??null})}),e.jsx("div",{className:"hidden lg:flex lg:flex-col lg:flex-1 lg:basis-1/2 min-h-0 mafia-panel p-4",style:b?{height:b,maxHeight:b}:void 0,children:e.jsx(je,{logs:s.logs,players:s.players,language:c,className:"w-full h-full",title:u("logs_panel_title",c),emptyMessage:u("logs_panel_empty",c)})})]})}),e.jsx("div",{className:E?"flex-1 min-h-0":"mt-2 sm:mt-4",children:e.jsx(_e,{state:s,dispatch:a,fullHeight:E})})]}),i==="PLAYERS"&&e.jsx("div",{className:"h-full overflow-hidden",children:e.jsx("div",{className:"mafia-panel h-full overflow-hidden",children:e.jsx(we,{state:s})})}),i==="LOGS"&&e.jsx("div",{className:"h-full overflow-hidden",children:e.jsx("div",{className:"mafia-panel h-full overflow-hidden",children:e.jsx(Ee,{state:s,selectedRound:se,onSelectRound:re})})}),i==="RULES"&&e.jsx("div",{className:"h-full overflow-hidden",children:e.jsx("div",{className:"mafia-panel h-full overflow-hidden",children:e.jsx(z,{language:s.settings.language})})}),i==="CARDS"&&e.jsx("div",{className:"h-full overflow-hidden",children:e.jsx("div",{className:"mafia-panel h-full overflow-hidden",children:e.jsx(V,{language:s.settings.language})})}),i==="SETTINGS"&&e.jsx("div",{className:"h-full overflow-hidden",children:e.jsx("div",{className:"mafia-panel h-full overflow-hidden",children:e.jsxs("div",{className:"h-full overflow-y-auto text-white px-3 pt-6 pb-24 sm:px-4 sm:pt-8 space-y-6",children:[e.jsx($,{translationLanguage:c,activeLanguage:c,optionBaseClasses:B,onSelectLanguage:oe}),e.jsxs("div",{className:"mafia-panel p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between text-sm uppercase tracking-[0.4em] text-slate-300",children:[e.jsx("span",{children:u("settings_player_node_size",c)}),e.jsxs("span",{className:"font-mono text-slate-50",children:[O,"%"]})]}),e.jsx("input",{type:"range",min:k,max:D,step:10,value:O,onChange:t=>a({type:"UPDATE_SETTINGS",payload:{playerNodeScale:Number(t.target.value)/100*N}}),className:"w-full mt-3 touch-slider"}),e.jsx("button",{onClick:()=>a({type:"UPDATE_SETTINGS",payload:{playerNodeScale:N}}),className:"text-xs text-[var(--color-brass)] underline mt-2",children:u("settings_reset_player_size",c)}),e.jsx("p",{className:"text-xs text-slate-300 mt-1",children:u("settings_player_node_hint",c)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between text-sm uppercase tracking-[0.4em] text-slate-300",children:[e.jsx("span",{children:u("settings_bullet_speed",c)}),e.jsxs("span",{className:"font-mono text-slate-50",children:[Y," ms"]})]}),e.jsx("input",{type:"range",min:U,max:H,step:50,value:Y,onChange:t=>a({type:"UPDATE_SETTINGS",payload:{bulletSpeed:Number(t.target.value)}}),className:"w-full mt-3 touch-slider"}),e.jsxs("div",{className:"flex justify-between text-xs text-slate-400 mt-1",children:[e.jsx("span",{children:u("settings_bullet_speed_fast",c)}),e.jsx("span",{children:u("settings_bullet_speed_slow",c)})]}),e.jsx("p",{className:"text-xs text-slate-300 mt-1",children:u("settings_bullet_speed_hint",c)})]})]}),e.jsxs("div",{className:"mafia-panel p-4 space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:u("settings_storage_title",c)}),e.jsxs("div",{className:"grid gap-3 sm:grid-cols-2",children:[e.jsx("button",{onClick:ce,className:"w-full mafia-button mafia-button--brass p-3 rounded font-semibold uppercase tracking-[0.3em]",children:u("settings_export_data_button",c)}),e.jsx("button",{onClick:()=>T.current?.click(),className:"w-full mafia-button mafia-button--ember p-3 rounded font-semibold uppercase tracking-[0.3em]",children:u("settings_import_data_button",c)})]}),e.jsx("input",{ref:T,type:"file",accept:"application/json",className:"hidden",onChange:ue}),e.jsx("p",{className:"text-xs text-slate-300",children:u("settings_import_warning",c)})]})]})})})]}),e.jsx("div",{className:"shrink-0","aria-hidden":!0,style:R})]}),e.jsx(W,{activeTab:i,setTab:v,isGm:!0,language:c})]}):n==="PLAYER_GAME"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mafia-app flex flex-col",style:y,children:[e.jsxs("div",{className:"flex-1 overflow-hidden mafia-screen rounded-t-[2rem] border border-[rgba(242,200,121,0.12)] p-3 sm:p-6",children:[i==="GAME"&&e.jsx("div",{className:"mafia-panel h-full overflow-hidden",children:e.jsx(Ae,{artMode:C,onArtModeChange:F,language:h})}),i==="CARDS"&&e.jsx("div",{className:"mafia-panel h-full overflow-hidden",children:e.jsx(V,{language:h,artMode:C,onArtModeChange:F})}),i==="RULES"&&e.jsx("div",{className:"mafia-panel h-full overflow-hidden",children:e.jsx(z,{language:h})}),i==="SETTINGS"&&e.jsx("div",{className:"mafia-panel h-full overflow-hidden",children:e.jsx("div",{className:"h-full overflow-y-auto text-white px-3 pt-6 pb-24 sm:px-4 sm:pt-8 space-y-6",children:e.jsx($,{translationLanguage:h,activeLanguage:h,optionBaseClasses:B,onSelectLanguage:de})})})]}),e.jsx("div",{className:"shrink-0","aria-hidden":!0,style:R})]}),e.jsx(W,{activeTab:i,setTab:v,isGm:!1,language:h})]}):null}function Ie(l,r){let f=!1;const d=i=>i.settings.language===r?i:(f=!0,{...i,settings:{...i.settings,language:r}}),a=l.past.map(d),n=d(l.present),p=l.future.map(d);return f?{past:a,present:n,future:p}:l}function Te(l){if(l.phase==="NIGHT_REPLAY")return new Set(l.players.map(a=>a.id));const r=new Set;if(l.phase!=="NIGHT_ACTIVE"||!l.activeCard)return r;const f=l.uiState.pendingPrompts[0],d=l.uiState.selectionContext;if(l.activeCard.cardId==="Mage"&&f==="wake_up_mage_to"){const a=d?.cardId==="Mage"?d.data?.sourceId:void 0;a&&r.add(a)}if(l.activeCard.cardId==="BlindExecutioner"&&f==="wake_up_executioner_victim"){const a=d?.cardId==="BlindExecutioner"?d.data?.savedId:void 0;a&&r.add(a)}if(l.activeCard.cardId==="Doctor"){const a=l.players.find(n=>n.cards.some(p=>p.cardId==="Doctor"&&p.instance===l.activeCard.instance));a&&!xe(l)&&r.add(a.id)}if(l.activeCard.cardId==="Sock"&&f==="wake_up_sock_second"){const a=d?.cardId==="Sock"?d.data?.firstTargetId:void 0;if(a){const n=l.players.filter(i=>i.status.isAlive),p=n.findIndex(i=>i.id===a);if(p!==-1){const i=new Set;if(n.length>1){const v=n[(p-1+n.length)%n.length];i.add(v.id);const w=n[(p+1)%n.length];i.add(w.id)}n.forEach(v=>{(v.id===a||!i.has(v.id))&&r.add(v.id)})}}}return r}function $({translationLanguage:l,activeLanguage:r,optionBaseClasses:f,onSelectLanguage:d}){return e.jsxs("div",{className:"mafia-panel p-4 space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h2",{className:"text-2xl font-bold mafia-title text-[var(--color-brass)]",children:u("settings_title",l)})}),e.jsx("div",{children:e.jsx("h3",{className:"text-lg font-semibold",children:u("settings_language_title",l)})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3",children:J.map(a=>{const n=a.code===r,p=n?"border-[rgba(242,200,121,0.7)] bg-[rgba(242,200,121,0.1)] text-white":"border-[rgba(242,200,121,0.2)] bg-[rgba(8,8,12,0.6)] text-slate-200 hover:border-[rgba(242,200,121,0.35)]";return e.jsxs("button",{onClick:()=>d(a.code),"aria-pressed":n,disabled:n,className:`${f} ${p}`,children:[e.jsx("div",{className:"text-base font-semibold",children:a.label}),e.jsx("span",{"aria-hidden":!n,className:`mt-2 inline-flex items-center gap-1 rounded-full bg-white/10 px-2 py-0.5 text-[0.65rem] font-semibold text-white transition-opacity duration-150 ${n?"":"opacity-0 pointer-events-none select-none"}`,children:u("settings_language_active",l)})]},a.code)})})]})}me.createRoot(document.getElementById("root")).render(e.jsx(pe.StrictMode,{children:e.jsx(Ce,{})}));
